<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>input,select,textarea,button{font-size:16px}</style>
  <title>Dexter • Dashboard</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:#0b0c10; color:#e6edf3; }
    header { padding: 16px; background:#11131a; border-bottom:1px solid #222633; display:flex; align-items:center; gap:12px; }
    h1 { font-size: 16px; margin:0; }
    .spacer { flex:1 1 auto; }
    .cta { background:#1a2233; color:#e6edf3; border:1px solid #2c3242; border-radius:6px; padding:6px 10px; font-weight:600; text-decoration:none; }
    .cta:hover { border-color:#3a4155; }
    main { display:grid; grid-template-columns: 1fr 1fr; gap: 16px; padding:16px; }
    .card { background:#0f1117; border:1px solid #1c2230; border-radius:8px; padding:12px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .badge { padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #2c3242; color:#9fb2c8; }
    .badge.ok { color:#79e08f; border-color:#2a4a36; background:#0f1612; }
    .badge.warn { color:#f2cc60; border-color:#4a3f2a; background:#15130f; }
    .badge.bad { color:#ff7b7b; border-color:#5a2a30; background:#1a1112; }
    .title { font-weight:600; margin-bottom:6px; }
    .small { font-size:12px; color:#9fb2c8; }
    a { color:#8ab4ff; text-decoration:none; }
    .grid { display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:8px; }
    .tinybtn { font-size:11px; padding:2px 6px; border:1px solid #2c3242; border-radius:4px; color:#9fb2c8; background:#121521; cursor:pointer; margin-left:auto; }
    .tinybtn:hover { color:#e6edf3; border-color:#3a4155; }
    /* Peek-collapse styles */
    .collapse-peek { position: relative; max-height: 160px; overflow: hidden; }
    .collapse-peek::after { content:''; position:absolute; left:0; right:0; bottom:0; height:36px; background: linear-gradient(to bottom, rgba(11,12,16,0), rgba(11,12,16,1)); pointer-events:none; }
    .collapse-peek.expanded { max-height: none; }
    .collapse-peek.expanded::after { display: none; }
    .list { display:grid; gap:8px; }
  </style>
</head>
<body>
  <header>
    <h1>Dexter • Dashboard</h1>
    <div class="spacer"></div>
    <a class="cta" href="./agent-live.html">Open Live Trenching</a>
  </header>
  <main>
    <section class="card" id="now">
      <div class="title">Now Running</div>
      <div class="row" id="nowRow"><span class="small">Waiting…</span></div>
    </section>
    <section class="card">
      <div class="title">Quick Links</div>
      <div class="list small">
        <a class="cta" href="./agent-live.html" target="_blank">Open Live Trenching</a>
      </div>
    </section>
    <section class="card" style="grid-column: 1 / span 2">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="title">Recent Runs</div>
        <button id="toggleRecent" class="tinybtn">Show all</button>
      </div>
      <div id="recentWrap" class="collapse-peek"><div id="recent" class="grid"></div></div>
    </section>
    <section class="card" style="grid-column: 1 / span 2">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="title">Architecture Overview</div>
        <button id="toggleArch" class="tinybtn">Expand</button>
      </div>
      <div id="archWrap" class="collapse-peek">
        <pre class="small" style="margin:0; white-space:pre; overflow:auto">
                           (optional direct)
  CLI Terminal -----------------------------> [ Agent CLI ]
  node index.js &lt;MINT&gt;                           token-ai/index.js
             |                                         |
             |                                         | emits HTTP events → POST /events
             |                                         v
[ Browser UI ]-- POST /run -----------------> [ Live UI Server ] -----------------------------.
agent-live.html        JSON { mint }             token-ai/server.js                           |
ws://host:port/ws                              - spawns agent child                           |
(subscribes to WS)                              - broadcasts WS events                         |
                                                - /ohlcv proxy (Birdeye)                      |
                                                - /recent-analyses, /latest-analysis          |
             ^                                         |                                      |
             | &lt;====== WS: ai_session/runner events ===|======================================|
             |        status, tool_call, partial, metrics, final_json                         |
             |                                                                                 |
             |                                                                                 v
             |                                 [ Child: Agent CLI ]                        writes
             |                                 - loads memory (DB/FS)                      reports
             |                                 - builds prompts                             under:
             |                                 - executes tools via core/exec-tools.js      reports/
             |                                 - posts events                                ai-token-analyses/
             |                                           |                                    gpt5-analysis-*.json
             |                                           | tool_call: socials_orchestrate     latest-*.json
             |                                           v
             |                                 [ Tool Executor ] (core/exec-tools.js)
             |                                 - routes tool calls
             |                                 - spawns orchestrator child
             |                                           |
             |                                           v
             |                                 [ Socials Orchestrator ]
             |                                 token-ai/socials/orchestrator.js
             |                                 - steps: market, website, telegram, x
             |                                 - Playwright/APIs, persists JSON to socials/reports/
             |                                 - prints REPORT_FILE:/abs/path.json
             |                                           |
             |                                           v
             |                                 exec-tools reads report, normalizes links
             |                                 returns data to Agent
             |                                           |
             |                                           | tool_call: analyze_token_ohlcv_range
             |                                           v
             |                                 Birdeye v3 OHLCV (fast)  &lt;----.
             |                                 - range + interval fetch        |  external APIs
             |                                 - summarized to memory          |  - DexScreener
             |                                                                  - Birdeye v3
             |                                                                  - X/Twitter
             |                                                                  - Telegram
             |                                           ^
             |                                           |
             |                                 Agent correlates socials + OHLCV
             |                                 may web_search in gather rounds
             |                                 then Finalize (pure) → JSON
             |                                           |
             |                                           v
             +------------------- UI shows timeline, metrics, streamed text, final scores

Finalize (important):
- Pure synthesis: no tool calls, no parallel_tool_calls.
- Non‑stream strict JSON via json_schema.
- Draft → valid JSON repair if parsing fails (uses just-produced draft).
- Memory update only on schema-valid JSON.
        </pre>
      </div>
    </section>
    <section class="card" style="grid-column: 1 / span 2">
      <div class="title">Quick Resolver (DexScreener)</div>
      <div class="row" style="gap:8px; align-items:flex-end; flex-wrap:wrap">
        <div>
          <div class="small">Symbol</div>
          <input id="resSym" placeholder="e.g., BONK" style="background:#0b0c10;border:1px solid #2c3242;border-radius:4px;color:#e6edf3;padding:6px 8px;width:160px" />
        </div>
        <div>
          <div class="small">Chain</div>
          <select id="resChain" style="background:#0b0c10;border:1px solid #2c3242;border-radius:4px;color:#e6edf3;padding:6px 8px;">
            <option value="solana" selected>solana</option>
            <option value="ethereum">ethereum</option>
            <option value="bsc">bsc</option>
          </select>
        </div>
        <button id="resBtn" class="tinybtn">Resolve</button>
      </div>
      <div id="resOut" class="small" style="margin-top:10px"></div>
    </section>
  </main>

  <script>
    (function(){
      const nowRow = document.getElementById('nowRow');
      const recent = document.getElementById('recent');
      const recentWrap = document.getElementById('recentWrap');
      const toggleRecent = document.getElementById('toggleRecent');
      const toggleArch = document.getElementById('toggleArch');
      const archWrap = document.getElementById('archWrap');
      const runs = [];
      let collapsed = true;
      let archCollapsed = true;

      function wsUrl(){
        try {
          const url = new URL(window.location.href);
          const override = url.searchParams.get('ws');
          if (override) return override;
          if (url.hostname === 'dexter.cash') return 'wss://dexter.cash/ws';
          const scheme = (url.protocol === 'https:') ? 'wss:' : 'ws:';
          return `${scheme}//${url.host}/ws`;
        } catch {
          const scheme = (location.protocol === 'https:') ? 'wss:' : 'ws:';
          return `${scheme}//${location.host}/ws`;
        }
      }
      function badge(text){ const s = document.createElement('span'); s.className='badge'; s.textContent=text; return s; }
      function small(text){ const s = document.createElement('span'); s.className='small'; s.textContent=text; return s; }
      function scoreClass(val, kind){ try { if(typeof val!== 'number') return ''; if(kind==='risk'){ if(val<=3) return 'ok'; if(val<=6) return 'warn'; return 'bad'; } if(kind==='branch'){ if(val>=70) return 'ok'; if(val>=40) return 'warn'; return 'bad'; } } catch{} return ''; }
      function timeAgo(ms) {
        if (!ms) return '';
        const seconds = Math.floor((Date.now() - ms) / 1000);
        if (seconds < 60) return seconds + 's ago';
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return minutes + 'm ago';
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return hours + 'h ago';
        const days = Math.floor(hours / 24);
        return days + 'd ago';
      }
      function card(item){
        const d = document.createElement('div'); d.className='card';
        // Create clickable title link
        const title = document.createElement('a'); 
        title.className='title'; 
        title.style.textDecoration = 'none';
        title.style.color = 'inherit';
        title.style.cursor = 'pointer';
        title.style.transition = 'color 0.2s';
        title.onmouseover = () => { title.style.color = '#8ab4ff'; };
        title.onmouseout = () => { title.style.color = 'inherit'; };
        
        // Set the link destination
        if (item.file) { 
          title.href = '/report-view.html?file=' + encodeURIComponent(item.file); 
        } else { 
          title.href = './agent-live.html'; 
        }
        title.target = '_blank';
        
        // Display symbol if available, otherwise first 8 chars of mint
        let displayTitle = item.symbol || (item.mint||'').slice(0,8)+'…';
        const symbolSpan = document.createElement('span');
        symbolSpan.textContent = displayTitle;
        title.appendChild(symbolSpan);
        
        // Add name in smaller text if available (show even if same as symbol for consistency)
        if (item.name) {
          const nameSpan = document.createElement('span');
          nameSpan.style.fontSize = '12px';
          nameSpan.style.color = '#9fb2c8';
          nameSpan.style.marginLeft = '8px';
          nameSpan.style.fontWeight = 'normal';
          nameSpan.textContent = item.name;
          title.appendChild(nameSpan);
        }
        d.appendChild(title);
        const row = document.createElement('div'); row.className='row';
        const b1 = badge('Branch: ' + (item.branchScore ?? '—')); const cls1 = scoreClass(item.branchScore,'branch'); if (cls1) b1.classList.add(cls1); row.appendChild(b1);
        const b2 = badge('Risk: ' + (item.riskScore ?? '—') + '/10'); const cls2 = scoreClass(item.riskScore,'risk'); if (cls2) b2.classList.add(cls2); row.appendChild(b2);
        if (item.mtime) row.appendChild(small(timeAgo(item.mtime)));
        d.appendChild(row);
        return d;
      }
      function renderRecent(){
        recent.innerHTML='';
        const items = runs.slice(-10);  // No reverse - newest ARE last, and should show last (at bottom)
        items.forEach(r => recent.appendChild(card(r)));
        try { toggleRecent.textContent = collapsed ? `Show all (${items.length})` : 'Collapse'; } catch {}
        try { if (collapsed) recentWrap.classList.remove('expanded'); else recentWrap.classList.add('expanded'); } catch {}
      }
      try {
        toggleRecent.addEventListener('click', ()=>{ collapsed = !collapsed; renderRecent(); });
      } catch {}
      try {
        toggleArch.addEventListener('click', ()=>{
          archCollapsed = !archCollapsed;
          if (archCollapsed) { archWrap.classList.remove('expanded'); toggleArch.textContent='Expand'; }
          else { archWrap.classList.add('expanded'); toggleArch.textContent='Collapse'; }
        });
      } catch {}
      function setNow(data){
        nowRow.innerHTML='';
        nowRow.appendChild(badge((data.mint||'').slice(0,8)+'…'));
        nowRow.appendChild(badge(data.phase||'running'));
        if (data.branchScore!=null) { const b=badge('Branch: '+data.branchScore); const cls=scoreClass(data.branchScore,'branch'); if (cls) b.classList.add(cls); nowRow.appendChild(b); }
        if (data.riskScore!=null) { const r=badge('Risk: '+data.riskScore+'/10'); const cls=scoreClass(data.riskScore,'risk'); if (cls) r.classList.add(cls); nowRow.appendChild(r); }
      }

      const ws = new WebSocket(wsUrl());
      ws.addEventListener('open', ()=>{
        ws.send(JSON.stringify({ type:'SUBSCRIBE', topic:'terminal' }));
      });
      let current = null, started = 0;
      ws.addEventListener('message', (ev)=>{
        try {
          const msg = JSON.parse(ev.data);
          if (msg?.type !== 'DATA' || msg?.topic !== 'terminal' || msg?.subtype !== 'ai_session') return;
          const { event, data } = msg;
          if (event === 'agent:session_start') {
            current = { mint:data.mint }; started = Date.parse(data.started_at||new Date());
            setNow({ mint:data.mint, phase:'Socials' });
          } else if (event === 'agent:final_json') {
            try{
              const a = data.data || {};
              if (typeof a.branchScore==='number' || typeof a.riskScore==='number') setNow({ mint: current?.mint||a.tokenAddress, phase:'Finalizing', branchScore:a.branchScore, riskScore:a.riskScore });
            } catch{}
          } else if (event === 'agent:session_end') {
            const ended = Date.parse(data.ended_at || new Date());
            const duration = ended - started;
            runs.push({ mint: current?.mint || data.mint, duration_ms: duration, branchScore: (data.branchScore ?? null), riskScore:(data.riskScore ?? null) });
            renderRecent();
            setNow({ mint: current?.mint || data.mint, phase: data.ok? 'Done' : 'Error' });
          }
        } catch {}
      });

      // Pull persisted recent analyses so dashboard shows history after restarts
      (async function loadRecent(){
        try {
          const u = new URL(window.location.href); u.pathname = '/recent-analyses'; u.searchParams.set('limit','12');
          const r = await fetch(u.toString());
          if (r.ok) {
            const j = await r.json();
            if (j?.ok && Array.isArray(j.items)) {
              for (const it of j.items) {
                runs.push({ mint: it.mint, name: it.name || null, symbol: it.symbol || null, branchScore: it.branchScore ?? null, riskScore: it.riskScore ?? null, duration_ms: it.duration_ms ?? null, file: it.file || null, mtime: it.mtime || null });
              }
              renderRecent();
            }
          }
        } catch {}
      })();
    })();
  </script>
  <script src="./js/dashboard-resolver.js"></script>
</body>
</html>
